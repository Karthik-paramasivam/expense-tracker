<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <title>ExpenseFlow - Premium Expense Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; }
        body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(180deg, #f0f3ff 0%, #f8f9fc 50%, #fdf5ff 100%); color: #1a202c; }
        
        .navbar { background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%); border-bottom: none; padding: 16px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.25); }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 26px; font-weight: 900; color: white; letter-spacing: -1px; text-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nav-info { font-size: 12px; color: rgba(255,255,255,0.95); font-weight: 700; }
        
        .container { padding: 24px; padding-bottom: 40px; max-width: 1200px; margin: 0 auto; }
        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 36px; font-weight: 950; color: #0f172a; margin-bottom: 8px; letter-spacing: -1.5px; }
        .page-subtitle { font-size: 15px; color: #64748b; font-weight: 500; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 32px; }
        .kpi-card { background: white; border-radius: 20px; padding: 26px; transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 2px solid rgba(255,255,255,0.8); }
        .kpi-card::before { content: ''; position: absolute; top: -60px; right: -60px; width: 180px; height: 180px; border-radius: 50%; opacity: 0.12; }
        .kpi-card::after { content: ''; position: absolute; bottom: -50px; left: -50px; width: 150px; height: 150px; border-radius: 50%; opacity: 0.08; }
        
        .kpi-card:nth-child(1) { background: linear-gradient(135deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.95) 100%); color: white; }
        .kpi-card:nth-child(1)::before { background: #667eea; }
        .kpi-card:nth-child(1)::after { background: #764ba2; }
        
        .kpi-card:nth-child(2) { background: linear-gradient(135deg, rgba(240,147,251,0.95) 0%, rgba(245,87,108,0.95) 100%); color: white; }
        .kpi-card:nth-child(2)::before { background: #f093fb; }
        .kpi-card:nth-child(2)::after { background: #f5576c; }
        
        .kpi-card:nth-child(3) { background: linear-gradient(135deg, rgba(79,172,254,0.95) 0%, rgba(0,242,254,0.95) 100%); color: white; }
        .kpi-card:nth-child(3)::before { background: #4facfe; }
        .kpi-card:nth-child(3)::after { background: #00f2fe; }
        
        .kpi-card:nth-child(4) { background: linear-gradient(135deg, rgba(67,233,123,0.95) 0%, rgba(56,249,215,0.95) 100%); color: white; }
        .kpi-card:nth-child(4)::before { background: #43e97b; }
        .kpi-card:nth-child(4)::after { background: #38f9d7; }
        
        .kpi-card:hover { transform: translateY(-6px); box-shadow: 0 16px 48px rgba(102, 126, 234, 0.25); }
        .kpi-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 900; margin-bottom: 12px; opacity: 0.95; position: relative; z-index: 2; }
        .kpi-value { font-size: 34px; font-weight: 950; margin-bottom: 8px; letter-spacing: -1px; position: relative; z-index: 2; line-height: 1; }
        .kpi-subtext { font-size: 13px; font-weight: 600; opacity: 0.9; position: relative; z-index: 2; }
        
        .card { background: white; border: 2px solid rgba(226,232,240,0.5); border-radius: 20px; padding: 28px; margin-bottom: 24px; animation: slideIn 0.6s ease forwards; box-shadow: 0 8px 32px rgba(0,0,0,0.06); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 12px 48px rgba(0,0,0,0.1); border-color: rgba(226,232,240,0.9); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 18px; border-bottom: 3px solid #f1f5f9; }
        .card-title { font-size: 20px; font-weight: 900; color: #0f172a; margin: 0; letter-spacing: -0.5px; }
        
        .chart-container { position: relative; height: 420px; margin-bottom: 24px; background: linear-gradient(135deg, #f8f9fc 0%, #f1f5f9 100%); border-radius: 18px; padding: 28px; border: 2px solid #e2e8f0; }
        .chart-wrapper { position: relative; height: 360px; }
        
        .form-wrapper { display: flex; flex-direction: column; gap: 20px; }
        .form-group { margin: 0; width: 100%; }
        .form-label { display: block; font-size: 13px; font-weight: 800; color: #334155; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.6px; }
        .form-input, .form-select { width: 100%; padding: 16px 18px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 15px; font-family: inherit; transition: all 0.3s ease; color: #1a202c; background-color: #ffffff; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); background-color: #f8f9fc; }
        .form-input::placeholder { color: #94a3b8; }
        
        .date-input { width: 100%; padding: 16px 18px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 15px; font-family: inherit; transition: all 0.3s ease; color: #1a202c; background-color: #ffffff; box-sizing: border-box; }
        .date-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); background-color: #f8f9fc; }
        
        .date-flex { display: flex; gap: 16px; }
        .date-flex .form-group { flex: 0 0 90%; }
        
        .form-btn { width: 100%; padding: 16px 28px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 14px; font-size: 14px; font-weight: 900; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.8px; box-shadow: 0 10px 28px rgba(102, 126, 234, 0.3); }
        .form-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 40px rgba(102, 126, 234, 0.4); }
        .form-btn:active { transform: scale(0.98); }
        
        .breakdown-list { display: flex; flex-direction: column; gap: 12px; }
        .breakdown-item { display: flex; align-items: center; justify-content: space-between; padding: 18px; background: linear-gradient(135deg, #f8f9fc 0%, #f1f5f9 100%); border-radius: 14px; border: 2px solid #e2e8f0; transition: all 0.3s ease; }
        .breakdown-item:hover { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); transform: translateX(4px); border-color: #667eea; }
        .breakdown-left { display: flex; align-items: center; gap: 14px; flex: 1; }
        .breakdown-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; font-weight: bold; }
        .breakdown-name { font-weight: 800; color: #1a202c; font-size: 14px; }
        .breakdown-percent { font-size: 12px; color: #64748b; margin-top: 3px; font-weight: 700; }
        .breakdown-amount { font-weight: 900; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 15px; min-width: 80px; text-align: right; }
        
        .filter-container { margin-bottom: 20px; overflow: hidden; }
        .filter-bar { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; -webkit-overflow-scrolling: touch; }
        .filter-btn { padding: 11px 18px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 13px; font-weight: 800; cursor: pointer; color: #64748b; text-transform: uppercase; letter-spacing: 0.4px; white-space: nowrap; flex-shrink: 0; transition: all 0.3s ease; }
        .filter-btn:hover { border-color: #667eea; color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .filter-btn.active { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; border-color: transparent; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35); }
        
        .transactions-list { display: flex; flex-direction: column; gap: 14px; }
        .transaction-item { display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center; padding: 18px; background: linear-gradient(135deg, #f8f9fc 0%, #f1f5f9 100%); border-radius: 14px; border: 2px solid #e2e8f0; transition: all 0.3s ease; }
        .transaction-item:hover { background: white; box-shadow: 0 6px 24px rgba(0,0,0,0.1); border-color: #667eea; }
        .transaction-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; font-weight: bold; }
        .transaction-content { display: flex; flex-direction: column; gap: 5px; }
        .transaction-desc { font-weight: 800; color: #1a202c; font-size: 14px; }
        .transaction-meta { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .transaction-category-tag { display: inline-block; padding: 5px 12px; background: linear-gradient(135deg, rgba(102,126,234,0.12) 0%, rgba(118,75,162,0.08) 100%); color: #667eea; border-radius: 8px; font-size: 11px; font-weight: 900; white-space: nowrap; border: 2px solid rgba(102,126,234,0.25); }
        .transaction-date { font-size: 12px; color: #64748b; white-space: nowrap; font-weight: 700; }
        .transaction-right { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .transaction-amount { font-weight: 900; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 15px; min-width: 65px; text-align: right; }
        .delete-btn { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #dc2626; border: none; border-radius: 10px; padding: 9px 14px; font-size: 13px; font-weight: 900; cursor: pointer; flex-shrink: 0; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15); }
        .delete-btn:hover { transform: scale(1.08); box-shadow: 0 6px 20px rgba(220, 38, 38, 0.25); }
        
        .empty-state { text-align: center; padding: 45px 20px; }
        .empty-icon { font-size: 54px; margin-bottom: 18px; }
        .empty-text { font-size: 14px; color: #64748b; margin: 0; font-weight: 700; }
        
        .trend-stats { margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fc 0%, #f1f5f9 100%); border-radius: 14px; border: 2px solid #e2e8f0; }
        .trend-stat-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
        .trend-stat { text-align: center; padding: 16px; background: white; border-radius: 12px; border: 2px solid #e2e8f0; }
        .trend-stat-label { font-size: 12px; color: #64748b; font-weight: 900; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px; }
        .trend-stat-value { font-size: 22px; font-weight: 950; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .trend-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .trend-table th, .trend-table td { padding: 14px 16px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        .trend-table th { background: linear-gradient(135deg, #f8f9fc 0%, #f1f5f9 100%); font-weight: 900; color: #1a202c; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .trend-table tr:hover { background: rgba(102, 126, 234, 0.05); }
        .trend-table td { font-weight: 700; color: #1a202c; }
        .trend-table .amount { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 900; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .trend-stat-row { grid-template-columns: 1fr; }
            .container { padding: 16px; }
            .chart-container { height: 350px; padding: 20px; }
            .chart-wrapper { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-container">
            <div class="logo">‚Çπ ExpenseFlow</div>
            <div class="nav-info" id="dateInfo"></div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Financial Overview</h1>
            <p class="page-subtitle">Premium Expense Tracker - Track & Analyze Your Spending</p>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Spent</div>
                <div class="kpi-value" id="totalExpense">‚Çπ0</div>
                <div class="kpi-subtext">All-time</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">This Month</div>
                <div class="kpi-value" id="monthExpense">‚Çπ0</div>
                <div class="kpi-subtext">Current</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Average</div>
                <div class="kpi-value" id="avgExpense">‚Çπ0</div>
                <div class="kpi-subtext">Per transaction</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Transactions</div>
                <div class="kpi-value" id="totalCount">0</div>
                <div class="kpi-subtext">Total recorded</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üí∞ Spending by Category</h2>
            </div>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">‚ûï Add Transaction</h2>
            </div>
            <div class="form-wrapper">
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="description" class="form-input" placeholder="e.g., Grocery Shopping">
                </div>
                <div class="date-flex">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="expenseDate" class="date-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" id="amount" class="form-input" placeholder="0" min="0" step="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="category" class="form-select">
                        <option value="Food">üçΩÔ∏è Food & Dining</option>
                        <option value="Transport">üöó Transportation</option>
                        <option value="Entertainment">üé¨ Entertainment</option>
                        <option value="Health">ü©∫ Health</option>
                        <option value="Shopping">üõçÔ∏è Shopping</option>
                        <option value="Bills">üí∞ Utilities & Bills</option>
                        <option value="Work">üíº Work</option>
                        <option value="Other">üìå Other</option>
                    </select>
                </div>
                <button class="form-btn" onclick="addExpense()">+ Add Transaction</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìä Category Breakdown</h2>
            </div>
            <div class="breakdown-list" id="breakdown">
                <div class="empty-state" style="padding: 20px 0;">
                    <p class="empty-text">No transactions yet</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üì± Recent Transactions</h2>
            </div>
            <div class="filter-container">
                <div class="filter-bar" id="filterBar"></div>
            </div>
            <div class="transactions-list" id="transactionsList">
                <div class="empty-state" style="padding: 30px 20px;">
                    <div class="empty-icon">üìä</div>
                    <p class="empty-text">No transactions recorded. Add one to get started.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìà Spending Trends</h2>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto;">
                <button class="filter-btn" onclick="switchTrendView('daily')" style="flex: 1;">üìÖ Daily</button>
                <button class="filter-btn active" onclick="switchTrendView('monthly')" style="flex: 1;">üìÖ Monthly</button>
                <button class="filter-btn" onclick="switchTrendView('weekly')" style="flex: 1;">üìä Weekly</button>
                <button class="filter-btn" onclick="switchTrendView('yearly')" style="flex: 1;">üìà Yearly</button>
            </div>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="trend-stats">
                <div class="trend-stat-row">
                    <div class="trend-stat">
                        <div class="trend-stat-label">üîù Highest</div>
                        <div class="trend-stat-value" id="highestTrend">‚Çπ0</div>
                    </div>
                    <div class="trend-stat">
                        <div class="trend-stat-label">üìä Average</div>
                        <div class="trend-stat-value" id="avgTrend">‚Çπ0</div>
                    </div>
                    <div class="trend-stat">
                        <div class="trend-stat-label">üìâ Lowest</div>
                        <div class="trend-stat-value" id="lowestTrend">‚Çπ0</div>
                    </div>
                </div>
            </div>
            <table class="trend-table" id="trendTable">
                <thead>
                    <tr>
                        <th>Period</th>
                        <th style="text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody id="trendTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const categoryIcons = { 'Food': 'üçΩÔ∏è', 'Transport': 'üöó', 'Entertainment': 'üé¨', 'Health': 'ü©∫', 'Shopping': 'üõçÔ∏è', 'Bills': 'üí∞', 'Work': 'üíº', 'Other': 'üìå' };
        const categoryColors = { 'Food': '#fbbf24', 'Transport': '#ef4444', 'Entertainment': '#ec4899', 'Health': '#10b981', 'Shopping': '#f59e0b', 'Bills': '#3b82f6', 'Work': '#8b5cf6', 'Other': '#6b7280' };
        const chartColors = { 'Food': '#fbbf24', 'Transport': '#ef4444', 'Entertainment': '#ec4899', 'Health': '#10b981', 'Shopping': '#f59e0b', 'Bills': '#3b82f6', 'Work': '#8b5cf6', 'Other': '#6b7280' };

        let expenses = [];
        let selectedFilter = 'All';
        let chartInstance = null;
        let trendChartInstance = null;
        let currentTrendView = 'monthly';
        const STORAGE_KEY = 'expenseFlow_data_v3';

        function saveExpenses() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        function loadExpenses() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    expenses = JSON.parse(data);
                    return;
                }
            } catch (e) {
                console.error('Load error:', e);
            }
            expenses = [];
        }

        function formatCurrency(amount) {
            return '‚Çπ' + Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            document.getElementById('dateInfo').textContent = now.toLocaleDateString('en-US', options);
        }

        function setDefaultDate() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        function addExpense() {
            const description = document.getElementById('description').value.trim();
            const amount = parseInt(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const expenseDate = document.getElementById('expenseDate').value;

            if (!description || !amount || amount <= 0 || !expenseDate) {
                alert('Please fill in all fields');
                return;
            }

            expenses.unshift({
                id: Date.now(),
                description,
                amount,
                category,
                date: formatDate(expenseDate),
                displayDate: expenseDate,
                timestamp: new Date(expenseDate).toISOString()
            });

            saveExpenses();
            updateUI();
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = 'Food';
            setDefaultDate();
        }

        function deleteExpense(id) {
            expenses = expenses.filter(e => e.id !== id);
            saveExpenses();
            updateUI();
        }

        function filterCategory(category) {
            selectedFilter = category;
            renderFilterButtons();
            updateTransactions();
        }

        function switchTrendView(view) {
            currentTrendView = view;
            document.querySelectorAll('[onclick*="switchTrendView"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateTrendChart();
        }

        function renderFilterButtons() {
            const categories = ['All', 'Food', 'Transport', 'Entertainment', 'Health', 'Shopping', 'Bills', 'Work', 'Other'];
            let html = '';
            categories.forEach(cat => {
                html += `<button class="filter-btn ${selectedFilter === cat ? 'active' : ''}" onclick="filterCategory('${cat}')">${cat}</button>`;
            });
            document.getElementById('filterBar').innerHTML = html;
        }

        function getDailyTrends() {
            const trends = {};
            expenses.forEach(e => {
                const date = new Date(e.timestamp);
                const dayKey = date.toISOString().split('T')[0];
                trends[dayKey] = (trends[dayKey] || 0) + e.amount;
            });
            return Object.entries(trends)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .slice(-30)
                .map(([day, amount]) => {
                    const date = new Date(day);
                    const dayName = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                    return {label: dayName, amount, fullDate: day};
                });
        }

        function getMonthlyTrends() {
            const trends = {};
            expenses.forEach(e => {
                const date = new Date(e.timestamp);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                trends[monthKey] = (trends[monthKey] || 0) + e.amount;
            });
            return Object.entries(trends)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .slice(-12)
                .map(([month, amount]) => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', {month: 'short', year: '2-digit'});
                    return {label: monthName, amount, fullDate: month};
                });
        }

        function getWeeklyTrends() {
            const trends = {};
            expenses.forEach(e => {
                const date = new Date(e.timestamp);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                trends[weekKey] = (trends[weekKey] || 0) + e.amount;
            });
            return Object.entries(trends)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .slice(-12)
                .map(([week, amount]) => {
                    const date = new Date(week);
                    const endDate = new Date(date);
                    endDate.setDate(endDate.getDate() + 6);
                    return {label: `${date.getDate()}-${endDate.getDate()} ${date.toLocaleDateString('en-US', {month: 'short'})}`, amount, fullDate: week};
                });
        }

        function getYearlyTrends() {
            const trends = {};
            expenses.forEach(e => {
                const year = new Date(e.timestamp).getFullYear();
                trends[year] = (trends[year] || 0) + e.amount;
            });
            return Object.entries(trends)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([year, amount]) => ({label: year, amount, fullDate: year}));
        }

        function updateTrendChart() {
            let trendData = [];
            if (currentTrendView === 'daily') trendData = getDailyTrends();
            else if (currentTrendView === 'monthly') trendData = getMonthlyTrends();
            else if (currentTrendView === 'weekly') trendData = getWeeklyTrends();
            else trendData = getYearlyTrends();

            const labels = trendData.map(t => t.label);
            const data = trendData.map(t => t.amount);

            // Update table
            let tableHTML = '';
            trendData.forEach(item => {
                tableHTML += `<tr><td>${item.label}</td><td style="text-align: right;"><span class="amount">${formatCurrency(item.amount)}</span></td></tr>`;
            });
            document.getElementById('trendTableBody').innerHTML = tableHTML;

            if (!labels.length) {
                document.getElementById('highestTrend').textContent = '‚Çπ0';
                document.getElementById('avgTrend').textContent = '‚Çπ0';
                document.getElementById('lowestTrend').textContent = '‚Çπ0';
                if (trendChartInstance) {
                    trendChartInstance.data.labels = [];
                    trendChartInstance.data.datasets[0].data = [];
                    trendChartInstance.update();
                }
                return;
            }

            const highest = Math.max(...data);
            const lowest = Math.min(...data);
            const avg = Math.round(data.reduce((a, b) => a + b, 0) / data.length);

            document.getElementById('highestTrend').textContent = formatCurrency(highest);
            document.getElementById('avgTrend').textContent = formatCurrency(avg);
            document.getElementById('lowestTrend').textContent = formatCurrency(lowest);

            const ctx = document.getElementById('trendChart');
            if (trendChartInstance) {
                trendChartInstance.data.labels = labels;
                trendChartInstance.data.datasets[0].data = data;
                trendChartInstance.update();
            } else {
                trendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spending (‚Çπ)',
                            data: data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 4,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            pointRadius: 7,
                            pointHoverRadius: 9
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    font: { size: 14, family: "'Plus Jakarta Sans'", weight: 'bold' },
                                    color: '#1a202c',
                                    padding: 20,
                                    usePointStyle: true,
                                    boxWidth: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 16,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                borderColor: '#667eea',
                                borderWidth: 2,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return '‚Çπ ' + context.parsed.y.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 12, family: "'Plus Jakarta Sans'", weight: 'bold' },
                                    callback: function(value) {
                                        return '‚Çπ' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                    }
                                },
                                grid: {
                                    color: 'rgba(100, 116, 139, 0.12)',
                                    drawBorder: false
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 12, family: "'Plus Jakarta Sans'", weight: 'bold' }
                                },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function updateUI() {
            const total = expenses.reduce((sum, e) => sum + e.amount, 0);
            const now = new Date();
            const monthExpenses = expenses.filter(e => {
                const expDate = new Date(e.timestamp);
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            });
            const monthTotal = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
            const avg = expenses.length > 0 ? Math.round(total / expenses.length) : 0;

            document.getElementById('totalExpense').textContent = formatCurrency(total);
            document.getElementById('monthExpense').textContent = formatCurrency(monthTotal);
            document.getElementById('avgExpense').textContent = formatCurrency(avg);
            document.getElementById('totalCount').textContent = expenses.length;
            updateBreakdown();
            updateTransactions();
            updateChart();
            updateTrendChart();
        }

        function updateChart() {
            const categoryTotals = {};
            expenses.forEach(e => {
                categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = labels.map(cat => chartColors[cat]);

            const ctx = document.getElementById('categoryChart');
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.data.datasets[0].backgroundColor = colors;
                chartInstance.update();
            } else if (labels.length > 0) {
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Amount Spent (‚Çπ)',
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 2,
                            borderRadius: 12,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    font: { size: 14, family: "'Plus Jakarta Sans'", weight: 'bold' },
                                    color: '#1a202c',
                                    padding: 20,
                                    usePointStyle: true,
                                    boxWidth: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 14,
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                borderColor: '#667eea',
                                borderWidth: 2,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return '‚Çπ ' + context.parsed.x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 12, family: "'Plus Jakarta Sans'", weight: 'bold' },
                                    callback: function(value) {
                                        return '‚Çπ' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                    }
                                },
                                grid: {
                                    color: 'rgba(100, 116, 139, 0.12)',
                                    drawBorder: false
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 12, family: "'Plus Jakarta Sans'", weight: 'bold' }
                                },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function updateBreakdown() {
            const categoryTotals = {};
            const total = expenses.reduce((sum, e) => sum + e.amount, 0);
            expenses.forEach(e => {
                categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
            });

            if (Object.keys(categoryTotals).length === 0) {
                document.getElementById('breakdown').innerHTML = '<div class="empty-state" style="padding: 20px 0;"><p class="empty-text">No transactions yet</p></div>';
                return;
            }

            let html = '';
            Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1])
                .forEach(([cat, amount]) => {
                    const percent = total > 0 ? ((amount / total) * 100).toFixed(0) : 0;
                    html += `<div class="breakdown-item"><div class="breakdown-left"><div class="breakdown-icon" style="background: ${categoryColors[cat]}20;">${categoryIcons[cat]}</div><div><div class="breakdown-name">${cat}</div><div class="breakdown-percent">${percent}% of total</div></div></div><div class="breakdown-amount">${formatCurrency(amount)}</div></div>`;
                });
            document.getElementById('breakdown').innerHTML = html;
        }

        function updateTransactions() {
            const filtered = selectedFilter === 'All' ? expenses : expenses.filter(e => e.category === selectedFilter);

            if (filtered.length === 0) {
                document.getElementById('transactionsList').innerHTML = `<div class="empty-state" style="padding: 30px 20px;"><div class="empty-icon">üìä</div><p class="empty-text">${selectedFilter === 'All' ? 'No transactions recorded.' : `No ${selectedFilter} transactions found.`}</p></div>`;
                return;
            }

            let html = '';
            filtered.forEach(e => {
                html += `<div class="transaction-item"><div class="transaction-icon" style="background: ${categoryColors[e.category]}20;">${categoryIcons[e.category]}</div><div class="transaction-content"><div class="transaction-desc">${e.description}</div><div class="transaction-meta"><span class="transaction-category-tag">${e.category}</span><span class="transaction-date">${e.date}</span></div></div><div class="transaction-right"><span class="transaction-amount">${formatCurrency(e.amount)}</span><button class="delete-btn" onclick="deleteExpense(${e.id})">‚úï</button></div></div>`;
            });
            document.getElementById('transactionsList').innerHTML = html;
        }

        function init() {
            loadExpenses();
            updateDate();
            setDefaultDate();
            renderFilterButtons();
            updateUI();
            
            setInterval(saveExpenses, 5000);
            window.addEventListener('beforeunload', saveExpenses);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
